<script>
  function calculateDuty() {
    const monthlyRent = parseFloat(document.getElementById('monthlyRent').value);
    const leasePeriod = parseInt(document.getElementById('leasePeriod').value);
    const leaseType = document.getElementById('leaseType').value;
    const rentIncrease = parseFloat(document.getElementById('rentIncrease').value) || 0;
    const increaseType = document.getElementById('increaseType').value;
    const increaseEvery = parseInt(document.getElementById('increaseEvery').value) || 1;

    if (!monthlyRent || !leasePeriod) {
      alert('Please enter Monthly Rent and Lease Period.');
      return;
    }

    let months = leaseType === 'years' ? leasePeriod * 12 : leasePeriod;
    let rentTotal = 0;
    let currentRent = monthlyRent;

    for (let i = 1; i <= months; i++) {
      rentTotal += currentRent;
      if (increaseType === 'everyYear' && i % 12 === 0) {
        currentRent += (currentRent * rentIncrease) / 100;
      } else if (increaseType === 'everyXYear' && increaseEvery > 0 && i % (increaseEvery * 12) === 0) {
        currentRent += (currentRent * rentIncrease) / 100;
      }
    }

    const annualAverage = (rentTotal / months) * 12;

    let multiplier = 1;
    if (months <= 12) {
      multiplier = 1;
    } else if (months <= 24) {
      multiplier = 3;
    } else if (months <= 36) {
      multiplier = 1;
    } else if (months <= 60) {
      multiplier = 3;
    } else if (months <= 120) {
      multiplier = 4;
    } else if (months <= 240) {
      multiplier = 5;
    } else if (months <= 348) {
      multiplier = 6;
    } else {
      multiplier = 7;
    }

    const stampDuty = Math.ceil((annualAverage * multiplier) * 0.04);
    const registrationCharge = 1100;
    const totalCharges = stampDuty + registrationCharge;
    const shareAmount = totalCharges / 2;

    window.calculationOutput = {
      monthlyRent,
      leasePeriod: months,
      rentTotal,
      annualAverage,
      stampDuty,
      registrationCharge,
      totalCharges,
      shareAmount
    };

    document.getElementById('results').innerHTML = `
      <strong>Total Rent:</strong> ₹${rentTotal.toFixed(2)}<br>
      <strong>Annual Avg Rent:</strong> ₹${annualAverage.toFixed(2)}<br>
      <strong>Stamp Duty (4%):</strong> ₹${stampDuty}<br>
      <strong>Registration Charges:</strong> ₹${registrationCharge}<br>
      <strong>Total Charges:</strong> ₹${totalCharges}<br>
      <strong>50% Share (if shared):</strong> ₹${shareAmount.toFixed(2)}
    `;
  }

  function generatePDF() {
    const resultsElement = document.getElementById("results");
    if (!resultsElement.innerHTML.trim()) {
      alert("Please calculate first before downloading PDF.");
      return;
    }

    html2canvas(resultsElement, {
      scale: 2,
      useCORS: true
    }).then(canvas => {
      const imgData = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({
        orientation: "portrait",
        unit: "mm",
        format: "a4"
      });

      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const imgProps = pdf.getImageProperties(imgData);
      const imgWidth = pageWidth - 40;
      const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
      const x = 20;
      const y = (pageHeight - imgHeight) / 2;

      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(16);
      pdf.text("Stamp Duty Calculation Report", pageWidth / 2, 20, { align: "center" });

      pdf.addImage(imgData, "PNG", x, y, imgWidth, imgHeight);

      pdf.setFontSize(10);
      pdf.setTextColor(100);
      const disclaimer = "Disclaimer: This report is generated from the free Commercial Rental Agreement Stamp Duty Calculator at www.merizameen.in";
      const footerLines = pdf.splitTextToSize(disclaimer, pageWidth - 40);
      pdf.text(footerLines, 20, pageHeight - 20);

      pdf.save("Stamp_Duty_Calculation_MeriZameen.pdf");
    });
  }
</script>
